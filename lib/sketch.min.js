var __slice=[].slice;(function(e){var t,n,r;return e.fn.sketch=function(){var n,r,i;r=arguments[0],n=2<=arguments.length?__slice.call(arguments,1):[],this.length>1&&e.error("Sketch.js can only be called on one element at a time."),i=this.data("sketch");if(typeof r!="string"||!i)return i?i:(this.data("sketch",new t(this.get(0),r)),this);if(!i[r])return e.error("Sketch.js did not recognize the given command.");if(typeof i[r]=="function")return i[r].apply(i,n);if(n.length===0)return i[r];if(n.length===1)return i[r]=n[0]},t=function(){function t(t,n){this.el=t,this.canvas=e(t),this.context=t.getContext("2d"),this.options=e.extend({toolLinks:!0,defaultTool:"marker",defaultColor:"#000000",defaultSize:5},n),this.painting=!1,this.color=this.options.defaultColor,this.size=this.options.defaultSize,this.tool=this.options.defaultTool,this.actions=[],this.action=[],this.canvas.bind("click mousedown mouseup mousemove mouseleave mouseout touchstart touchmove touchend touchcancel",this.onEvent),this.options.toolLinks&&e("body").delegate('a[href="#'+this.canvas.attr("id")+'"]',"click",function(t){var n,r,i,s,o,u,a;r=e(this),n=e(r.attr("href")),s=n.data("sketch"),a=["color","size","tool"];for(o=0,u=a.length;o<u;o++)i=a[o],r.attr("data-"+i)&&s.set(i,e(this).attr("data-"+i));return e(this).attr("data-download")&&s.download(e(this).attr("data-download")),e(this).attr("data-operation")&&s.operation(e(this).attr("data-operation")),!1})}return t.prototype.download=function(e){var t;return e||(e="png"),e==="jpg"&&(e="jpeg"),t="image/"+e,window.open(this.el.toDataURL(t))},t.prototype.set=function(e,t){return this[e]=t,this.canvas.trigger("sketch.change"+e,t)},t.prototype.startPainting=function(){return this.painting=!0,this.action={tool:this.tool,color:this.color,size:parseFloat(this.size),events:[]}},t.prototype.stopPainting=function(){return this.action&&this.actions.push(this.action),this.painting=!1,this.action=null,this.redraw()},t.prototype.onEvent=function(t){return t.originalEvent&&t.originalEvent.targetTouches&&(t.pageX=t.originalEvent.targetTouches[0].pageX,t.pageY=t.originalEvent.targetTouches[0].pageY),e.sketch.tools[e(this).data("sketch").tool].onEvent.call(e(this).data("sketch"),t),t.preventDefault(),!1},t.prototype.redraw=function(){var t;this.el.width=this.canvas.width(),this.context=this.el.getContext("2d"),t=this,e.each(this.actions,function(){if(this.tool)return e.sketch.tools[this.tool].draw.call(t,this)});if(this.painting&&this.action)return e.sketch.tools[this.action.tool].draw.call(t,this.action)},t.prototype.setupLine=function(e){return this.context.lineJoin="round",this.context.lineCap="round",this.context.lineWidth=e.size},t.prototype.operation=function(e){return e==="clear"&&(this.actions=[]),this.redraw()},t}(),e.sketch={tools:{}},e.sketch.tools.marker={onEvent:function(e){switch(e.type){case"mousedown":case"touchstart":this.startPainting();break;case"mouseup":case"mouseout":case"mouseleave":case"touchend":case"touchcancel":this.stopPainting()}if(this.painting)return this.action.events.push({x:e.pageX-this.canvas.offset().left,y:e.pageY-this.canvas.offset().top,event:e.type}),this.redraw()},draw:function(e){var t,n,r,i,s;this.context.lineJoin="round",this.context.lineCap="round",this.context.beginPath(),this.context.moveTo(e.events[0].x,e.events[0].y),s=e.events;for(r=0,i=s.length;r<i;r++)t=s[r],this.context.lineTo(t.x,t.y),n=t;return this.context.strokeStyle=e.color,this.context.lineWidth=e.size,this.context.stroke()}},e.sketch.tools.eraser={onEvent:function(t){return e.sketch.tools.marker.onEvent.call(this,t)},draw:function(t){var n;return n=this.context.globalCompositeOperation,this.context.globalCompositeOperation="copy",t.color="rgba(0,0,0,0)",e.sketch.tools.marker.draw.call(this,t),this.context.globalCompositeOperation=n}},e.sketch.tools.rectangle={onEvent:e.sketch.tools.marker.onEvent,draw:function(e){var t,n,r,i;return this.setupLine(e),r=e.events[0],this.context.moveTo(r.x,r.y),t=e.events[e.events.length-1],i=Math.abs(t.x-r.x),n=Math.abs(t.y-r.y),this.context.strokeStyle=e.color,this.context.strokeRect(r.x,r.y,i,n)}},e.sketch.tools.line={onEvent:e.sketch.tools.marker.onEvent,draw:function(e){var t;return this.setupLine(e),t=e.events[e.events.length-1],this.context.beginPath(),this.context.moveTo(e.events[0].x,e.events[0].y),this.context.lineTo(t.x,t.y),this.context.strokeStyle=n(),this.context.stroke()}},e.sketch.tools.circle={onEvent:e.sketch.tools.marker.onEvent,draw:function(e){var t,r,i,s,o;return this.setupLine(e),o=e.events[0],this.context.moveTo(e.events[0].x,e.events[0].y),s=e.events[e.events.length-1],t=Math.max(s.x,o.x)-Math.abs(s.x-o.x)/2,r=Math.max(s.y,o.y)-Math.abs(s.y-o.y)/2,i=Math.sqrt(Math.sqrt(Math.pow(s.x-o.x,2))+Math.pow(s.y-o.y,2)),this.context.beginPath(),this.context.strokeStyle=n(),this.context.arc(t,r,i,Math.PI*2,0,!0),this.context.stroke(),this.context.closePath()}},r=function(){return Math.floor(Math.random()*256)},n=function(){return"rgb("+r()+","+r()+","+r()+")"}})(jQuery);